#!/bin/bash

# ๐ SCRIPT DE VERIFICACIรN - FacturaXpress Pre-Hacienda
# Uso: bash verificar-app.sh
# Propรณsito: Validar que la aplicaciรณn estรฉ lista antes de pruebas

set -e

BOLD='\\033[1m'\nRESET='\\033[0m'\nGREEN='\\033[0;32m'\nRED='\\033[0;31m'\nYELLOW='\\033[1;33m'\n\necho -e \"${BOLD}๐ VERIFICACIรN DE FACTURAXPRESS${RESET}\"  \necho \"Fecha: $(date)\"  \necho \"\"\n\n# 1. Verificar Node.js y npm\necho -e \"${BOLD}1๏ธโฃ  Verificando Node.js y npm...${RESET}\"\nif command -v node &> /dev/null; then\n    NODE_VER=$(node --version)\n    NPM_VER=$(npm --version)\n    echo -e \"${GREEN}โ Node.js${RESET}: $NODE_VER\"\n    echo -e \"${GREEN}โ npm${RESET}: $NPM_VER\"\nelse\n    echo -e \"${RED}โ Node.js no encontrado${RESET}\"\n    exit 1\nfi\n\n# 2. Verificar dependencias instaladas\necho \"\"\necho -e \"${BOLD}2๏ธโฃ  Verificando dependencias...${RESET}\"\nif [ -d \"node_modules\" ]; then\n    echo -e \"${GREEN}โ node_modules existe${RESET}\"\nelse\n    echo -e \"${YELLOW}โ๏ธ  node_modules no existe${RESET}\"\n    echo \"   Ejecuta: npm install\"\nfi\n\nif grep -q '\"ajv\"' package.json; then\n    echo -e \"${GREEN}โ AJV instalado${RESET}\"\nelse\n    echo -e \"${RED}โ AJV no encontrado${RESET}\"\nfi\n\nif grep -q '\"better-sqlite3\"' package.json; then\n    echo -e \"${GREEN}โ better-sqlite3 instalado${RESET}\"\nelse\n    echo -e \"${RED}โ better-sqlite3 no encontrado${RESET}\"\nfi\n\n# 3. Verificar archivos clave\necho \"\"\necho -e \"${BOLD}3๏ธโฃ  Verificando archivos clave...${RESET}\"\nfiles=(\n    \"server/dgii-validator.ts\"\n    \"server/dgii-resources/factura-schema.json\"\n    \"server/routes.ts\"\n    \"server/storage.ts\"\n    \"server/catalogs.ts\"\n    \"client/src/hooks/use-validate-dte.ts\"\n    \"client/src/hooks/use-auth.ts\"\n    \"client/src/pages/nueva-factura.tsx\"\n    \"shared/schema.ts\"\n)\n\nfor file in \"${files[@]}\"; do\n    if [ -f \"$file\" ]; then\n        echo -e \"${GREEN}โ${RESET} $file\"\n    else\n        echo -e \"${RED}โ${RESET} $file (FALTANTE)\"\n    fi\ndone\n\n# 4. Verificar TypeScript\necho \"\"\necho -e \"${BOLD}4๏ธโฃ  Verificando TypeScript...${RESET}\"\nif npm run check 2>&1 | grep -q \"error TS\"; then\n    echo -e \"${RED}โ Errores TypeScript encontrados${RESET}\"\n    npm run check\nelse\n    echo -e \"${GREEN}โ Sin errores TypeScript${RESET}\"\nfi\n\n# 5. Verificar base de datos\necho \"\"\necho -e \"${BOLD}5๏ธโฃ  Verificando base de datos...${RESET}\"\nif [ -f \"app.db\" ]; then\n    echo -e \"${GREEN}โ app.db existe${RESET}\"\n    DB_SIZE=$(du -h app.db | cut -f1)\n    echo \"   Tamaรฑo: $DB_SIZE\"\nelse\n    echo -e \"${YELLOW}โ๏ธ  app.db no existe${RESET}\"\n    echo \"   Se crearรก automรกticamente al iniciar\"\nfi\n\n# 6. Verificar esquema JSON DGII\necho \"\"\necho -e \"${BOLD}6๏ธโฃ  Verificando schema DGII...${RESET}\"\nif [ -f \"server/dgii-resources/factura-schema.json\" ]; then\n    if grep -q '\"tipoDte\"' server/dgii-resources/factura-schema.json; then\n        echo -e \"${GREEN}โ Schema contiene tipoDte${RESET}\"\n    fi\n    if grep -q '\"numeroControl\"' server/dgii-resources/factura-schema.json; then\n        echo -e \"${GREEN}โ Schema contiene numeroControl${RESET}\"\n    fi\n    if grep -q '\"emisor\"' server/dgii-resources/factura-schema.json; then\n        echo -e \"${GREEN}โ Schema contiene emisor${RESET}\"\n    fi\nfi\n\n# 7. Verificar configuraciรณn de puerto\necho \"\"\necho -e \"${BOLD}7๏ธโฃ  Verificando configuraciรณn...${RESET}\"\nif grep -q \"5000\" server/index.ts; then\n    echo -e \"${GREEN}โ Servidor configurado para puerto 5000${RESET}\"\nfi\n\nif grep -q \"cross-env\" package.json; then\n    echo -e \"${GREEN}โ cross-env instalado${RESET}\"\nfi\n\n# 8. Verificar componentes React\necho \"\"\necho -e \"${BOLD}8๏ธโฃ  Verificando componentes React...${RESET}\"\ncomponents=(\n    \"client/src/components/theme-provider.tsx\"\n    \"client/src/components/theme-toggle.tsx\"\n    \"client/src/App.tsx\"\n)\n\nfor comp in \"${components[@]}\"; do\n    if [ -f \"$comp\" ]; then\n        echo -e \"${GREEN}โ${RESET} $(basename $comp)\"\n    fi\ndone\n\n# 9. Verificar documentaciรณn\necho \"\"\necho -e \"${BOLD}9๏ธโฃ  Verificando documentaciรณn...${RESET}\"\ndocs=(\n    \"VERIFICACION_PREVIA_MH.md\"\n    \"MEJORAS_IDENTIFICADAS.md\"\n    \"RESUMEN_VERIFICACION.md\"\n    \"DGII_VALIDATION.md\"\n    \"STATUS.md\"\n)\n\nfor doc in \"${docs[@]}\"; do\n    if [ -f \"$doc\" ]; then\n        echo -e \"${GREEN}โ${RESET} $doc\"\n    else\n        echo -e \"${YELLOW}โ๏ธ${RESET} $doc (NO ENCONTRADO)\"\n    fi\ndone\n\n# 10. Resumen final\necho \"\"\necho -e \"${BOLD}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}\"\necho -e \"${BOLD}RESUMEN DE VERIFICACIรN${RESET}\"\necho -e \"${BOLD}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}\"\necho \"\"\necho -e \"${GREEN}โ VERIFICACIONES COMPLETADAS${RESET}\"\necho \"\"\necho \"Prรณximos pasos:\"\necho \"  1. npm run dev                    (Iniciar servidor)\"\necho \"  2. Login: admin / admin           (Autenticaciรณn)\"\necho \"  3. Nueva Factura                  (Crear DTE)\"\necho \"  4. Validar contra schema DGII     (Verificaciรณn)\"\necho \"\"\necho \"Documentaciรณn importante:\"\necho \"  ๐ RESUMEN_VERIFICACION.md        (Resumen ejecutivo)\"\necho \"  ๐ VERIFICACION_PREVIA_MH.md      (Anรกlisis detallado)\"\necho \"  ๐ MEJORAS_IDENTIFICADAS.md       (Plan de mejoras)\"\necho \"\"\n\n# 11. Verificar si estรก listo\necho -e \"${BOLD}ESTADO DE PREPARACIรN${RESET}\"\necho \"\"\n\nREADY=true\n\n# Check critical items\nif [ ! -f \"server/dgii-validator.ts\" ]; then\n    echo -e \"${RED}โ CRรTICO: Falta validador DGII${RESET}\"\n    READY=false\nelse\n    echo -e \"${GREEN}โ${RESET} Validador DGII\"\nfi\n\nif [ ! -f \"server/dgii-resources/factura-schema.json\" ]; then\n    echo -e \"${RED}โ CRรTICO: Falta schema DGII${RESET}\"\n    READY=false\nelse\n    echo -e \"${GREEN}โ${RESET} Schema DGII\nfi\n\nif npm run check 2>&1 | grep -q \"error TS\"; then\n    echo -e \"${RED}โ CRรTICO: Errores TypeScript${RESET}\"\n    READY=false\nelse\n    echo -e \"${GREEN}โ${RESET} Sin errores TypeScript\"\nfi\n\necho \"\"\n\nif [ \"$READY\" = true ]; then\n    echo -e \"${GREEN}${BOLD}โ LA APLICACIรN ESTร LISTA PARA PRUEBAS${RESET}\"\n    echo \"\"\n    echo -e \"${YELLOW}โ๏ธ  RECUERDA:${RESET}\"\n    echo \"   โข Implementar nรบmero de control seguro (CRรTICO)\"\n    echo \"   โข Validar estructura DTE vs schema DGII\"\n    echo \"   โข Para firma y transmisiรณn MH necesitas certificado\"\nelse\n    echo -e \"${RED}${BOLD}โ HAY PROBLEMAS QUE RESOLVER${RESET}\"\n    exit 1\nfi\n\necho \"\"\necho \"โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\"\necho \"Verificaciรณn completada: $(date)\"\necho \"โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\"\n