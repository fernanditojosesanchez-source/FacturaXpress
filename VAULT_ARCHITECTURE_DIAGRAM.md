# ğŸ—ï¸ ARQUITECTURA DE SEGURIDAD - DIAGRAMA TÃ‰CNICO

**VersiÃ³n:** 1.0  
**Fecha:** 2026-01-14  
**Estado:** âœ… IMPLEMENTADO

---

## ğŸ“Š DIAGRAMA GENERAL DE FLUJOS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APLICACIÃ“N FACTURAEXPRESS                       â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      FRONTEND (React)                       â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â€¢ Usuario sube archivo P12                                â”‚  â”‚
â”‚  â”‚  â€¢ Usuario ingresa contraseÃ±a                              â”‚  â”‚
â”‚  â”‚  â€¢ Usuario configura credenciales MH                       â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  âŒ NUNCA VE:                                               â”‚  â”‚
â”‚  â”‚     - Certificados desencriptados                          â”‚  â”‚
â”‚  â”‚     - ContraseÃ±as en plaintext                             â”‚  â”‚
â”‚  â”‚     - Credenciales de terceros                             â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚ HTTPS/TLS                               â”‚
â”‚                         â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   BACKEND (Express.js)                      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  1. Recibe datos del cliente                              â”‚  â”‚
â”‚  â”‚  2. Valida entrada:                                        â”‚  â”‚
â”‚  â”‚     - Â¿Es P12 vÃ¡lido?                                     â”‚  â”‚
â”‚  â”‚     - Â¿TamaÃ±o correcto?                                   â”‚  â”‚
â”‚  â”‚     - Â¿Usuario autenticado?                                â”‚  â”‚
â”‚  â”‚  3. Llama a storage.ts                                     â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  âŒ NUNCA GUARDA:                                           â”‚  â”‚
â”‚  â”‚     - Certificados en BD normal                            â”‚  â”‚
â”‚  â”‚     - ContraseÃ±as en texto plano                           â”‚  â”‚
â”‚  â”‚     - Credenciales sin encriptaciÃ³n Supabase              â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                          â”‚
â”‚                         â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              STORAGE LAYER (storage.ts)                    â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  saveCertificateToVault()                                  â”‚  â”‚
â”‚  â”‚  getCertificateFromVault()                                 â”‚  â”‚
â”‚  â”‚  saveMHCredentialsToVault()                               â”‚  â”‚
â”‚  â”‚  getMHCredentialsFromVault()                              â”‚  â”‚
â”‚  â”‚  secretExists()                                            â”‚  â”‚
â”‚  â”‚  deleteCertificateSecretsFromVault()                      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â†“ Delega a:                                              â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                          â”‚
â”‚                         â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            VAULT SERVICE LAYER (vault.ts)                  â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  saveSecretToVault()    â”€â”€â†’ Encripta, audita, guarda      â”‚  â”‚
â”‚  â”‚  getSecretFromVault()   â”€â”€â†’ Desencripta, audita, retorna â”‚  â”‚
â”‚  â”‚  deleteSecretFromVault() â”€â”€â†’ Elimina, audita (irreversible)  â”‚  â”‚
â”‚  â”‚  secretExists()          â”€â”€â†’ Verifica sin decriptar      â”‚  â”‚
â”‚  â”‚  listTenantSecrets()     â”€â”€â†’ Lista metadatos solamente   â”‚  â”‚
â”‚  â”‚  logVaultAccess()        â”€â”€â†’ Audita cada operaciÃ³n       â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  Validaciones incluidas:                                   â”‚  â”‚
â”‚  â”‚  â€¢ Tipo de secreto (enum VaultSecretType)                â”‚  â”‚
â”‚  â”‚  â€¢ TamaÃ±o mÃ¡ximo (100KB)                                  â”‚  â”‚
â”‚  â”‚  â€¢ Tenant isolation (todos queries filtran por tenant)   â”‚  â”‚
â”‚  â”‚  â€¢ AuditorÃ­a automÃ¡tica (ip_address, user_id, etc)      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                          â”‚
â”‚                         â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         SUPABASE VAULT API                                 â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  vault.create_secret()                                     â”‚  â”‚
â”‚  â”‚  vault.update_secret()                                     â”‚  â”‚
â”‚  â”‚  vault.delete_secret()                                     â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  Envuelve:                                                 â”‚  â”‚
â”‚  â”‚  â€¢ Validaciones PostgreSQL                                 â”‚  â”‚
â”‚  â”‚  â€¢ EncriptaciÃ³n AEAD (XChaCha20Poly1305)                 â”‚  â”‚
â”‚  â”‚  â€¢ Manejo de claves Supabase-managed                      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                          â”‚
â”‚                         â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        POSTGRESQL DATABASE (Supabase)                      â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ vault.secrets (ENCRIPTADO EN DISCO)                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ id   | key           | nonce  | encrypted_secret   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ UUID â”‚ certificate   â”‚ random â”‚ JXK9+...base64... â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ UUID â”‚ mh_password   â”‚ random â”‚ 7H2W+...base64... â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â”‚               â”‚        â”‚ (nunca texto plano)â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ”’ EncriptaciÃ³n: XChaCha20Poly1305 (libsodium)    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ”‘ Claves: Supabase-managed (fuera de BD)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ’¾ Almacenamiento: Encriptado en disco            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ”„ Backups: Encriptados                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ“¡ ReplicaciÃ³n: Encriptada                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ vault_references (MAPEO, NO SECRETOS)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ id    | tenant_id | secret_type   | secret_id   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ UUID  â”‚ abc-123   â”‚ cert_p12      â”‚ UUID        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ UUID  â”‚ abc-123   â”‚ cert_password â”‚ UUID        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ UUID  â”‚ abc-123   â”‚ mh_password   â”‚ UUID        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ” Purpose: Mapeo lÃ³gico a secretos encriptados   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ“ Location: Sin encriptaciÃ³n (metadatos)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ”’ ProtecciÃ³n: RLS (solo ve tu tenant)           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ vault_access_log (AUDITORÃA COMPLETA)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ id | user_id  | tenant_id | action | success â”‚  â”‚  â”‚
â”‚  â”‚  â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ .. â”‚ user123  â”‚ abc-123   â”‚ read   â”‚ true    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ .. â”‚ user456  â”‚ abc-123   â”‚ write  â”‚ true    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ .. â”‚ user789  â”‚ xyz-789   â”‚ delete â”‚ false   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ip_address | error_message | created_at          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 192.0.2.1  â”‚ NULL          â”‚ 2026-01-14 10:00   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 192.0.2.2  â”‚ NULL          â”‚ 2026-01-14 10:05   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 192.0.2.3  â”‚ Unauthorized  â”‚ 2026-01-14 10:10   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ“ Purpose: Historial de TODOS los accesos        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ” Auditable: QuiÃ©n, cuÃ¡ndo, desde dÃ³nde, resultado â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ”’ ProtecciÃ³n: RLS (solo ve tu tenant)           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ” Seguridad: NO SE PUEDE EDITAR/BORRAR          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ vault.decrypted_secrets (VW - RUNTIME ONLY)        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ âš ï¸ IMPORTANTE: Esta view SOLO existe en memoria   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ cuando se ejecuta la consulta. Los secretos se    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ desencriptan en el proceso, pero NUNCA se         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ almacenan desencriptados en disco.                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Acceso: Solo vÃ­a vault.ts                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ DesencriptaciÃ³n: AutomÃ¡tica por Supabase         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Storage: En memoria durante la transacciÃ³n       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                          â”‚
â”‚                         â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         SUPABASE MANAGED ENCRYPTION KEYS                   â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  UbicaciÃ³n: FUERA de la base de datos PostgreSQL          â”‚  â”‚
â”‚  â”‚  GestiÃ³n: Por Supabase (no accesible a desarrolladores)  â”‚  â”‚
â”‚  â”‚  Algoritmo: XChaCha20Poly1305                             â”‚  â”‚
â”‚  â”‚  RotaciÃ³n: AutomÃ¡tica por Supabase                        â”‚  â”‚
â”‚  â”‚  Backup: Las claves NO se incluyen en backups            â”‚  â”‚
â”‚  â”‚           (backups permanecen encriptados)                â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚  ğŸ”’ NUNCA exponemos las claves a la aplicaciÃ³n           â”‚  â”‚
â”‚  â”‚  ğŸ”’ NUNCA podemos ver el material de claves              â”‚  â”‚
â”‚  â”‚  ğŸ”’ NUNCA podemos perder las claves por error            â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO DETALLADO: GUARDAR CERTIFICADO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: CLIENTE INICIA                                          â”‚
â”‚                                                                 â”‚
â”‚ Usuario sube: p12.pfx + "MiContraseÃ±a"                         â”‚
â”‚                                                                 â”‚
â”‚ Frontend convierte:                                             â”‚
â”‚ p12File â†’ Base64 â†’ EnvÃ­a a servidor vÃ­a HTTPS                 â”‚
â”‚                                                                 â”‚
â”‚ âœ… Datos en trÃ¡nsito: Encriptados TLS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: SERVIDOR RECIBE                                         â”‚
â”‚                                                                 â”‚
â”‚ POST /api/tenants/:tenantId/certificados                       â”‚
â”‚ {                                                               â”‚
â”‚   "certificado": "MIIEpAIBAAKCAQEA...",                        â”‚
â”‚   "contraseÃ±a": "MiContraseÃ±a"                                 â”‚
â”‚ }                                                               â”‚
â”‚                                                                 â”‚
â”‚ req.user.id = "user-123"                                       â”‚
â”‚ req.socket.remoteAddress = "192.0.2.1"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: VALIDACIÃ“N EN SERVIDOR                                  â”‚
â”‚                                                                 â”‚
â”‚ 1. Â¿Es base64 vÃ¡lido?                    âœ… SI                 â”‚
â”‚ 2. Â¿Se puede decodificar?                âœ… SI                 â”‚
â”‚ 3. Â¿Es un P12 vÃ¡lido?                    âœ… SI                 â”‚
â”‚ 4. Â¿ContraseÃ±a funciona?                 âœ… SI                 â”‚
â”‚ 5. Â¿Usuario autenticado?                 âœ… SI                 â”‚
â”‚ 6. Â¿Usuario es admin del tenant?         âœ… SI                 â”‚
â”‚ 7. Â¿TamaÃ±o < 100KB?                      âœ… SI                 â”‚
â”‚                                                                 â”‚
â”‚ Si alguno es NO â†’ Responder error al cliente sin procesar     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 4: LLAMAR storage.saveCertificateToVault()                 â”‚
â”‚                                                                 â”‚
â”‚ await storage.saveCertificateToVault(                          â”‚
â”‚   "tenant-abc-123",      // tenantId                           â”‚
â”‚   "MIIEpAIBAAKCAQEA...", // p12Base64                          â”‚
â”‚   "user-123",            // userId                             â”‚
â”‚   "192.0.2.1"            // ipAddress                          â”‚
â”‚ );                                                              â”‚
â”‚                                                                 â”‚
â”‚ Delega a vault.ts:                                             â”‚
â”‚ saveSecretToVault(supabase, "tenant-abc-123", "cert_p12", ...) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 5: VAULT.TS PROCESA                                        â”‚
â”‚                                                                 â”‚
â”‚ 1. Validar:                                                     â”‚
â”‚    - Â¿secretContent es string? âœ… SI                            â”‚
â”‚    - Â¿TamaÃ±o <= 100000 bytes? âœ… SI                             â”‚
â”‚    - Â¿No estÃ¡ vacÃ­o? âœ… SI                                      â”‚
â”‚    - Â¿Type en enum? âœ… SI ("cert_p12")                         â”‚
â”‚                                                                 â”‚
â”‚ 2. Guardar en Vault (ENCRIPTADO):                              â”‚
â”‚    const { data, error } = await supabase.rpc(                â”‚
â”‚      'vault.create_secret',                                    â”‚
â”‚      {                                                          â”‚
â”‚        name: 'cert_tenant-abc-123_0',                          â”‚
â”‚        secret: 'MIIEpAIBAAKCAQEA...',  // Se encripta aquÃ­    â”‚
â”‚        description: 'cert_p12 for tenant-abc-123'             â”‚
â”‚      }                                                          â”‚
â”‚    );                                                           â”‚
â”‚                                                                 â”‚
â”‚ 3. Supabase encripta:                                          â”‚
â”‚    - Toma el secret en plaintext                               â”‚
â”‚    - Encripta con XChaCha20Poly1305                           â”‚
â”‚    - Usa Supabase-managed key (externa a BD)                  â”‚
â”‚    - Almacena encriptado en vault.secrets                     â”‚
â”‚    - Retorna secret_id (UUID)                                â”‚
â”‚                                                                 â”‚
â”‚ 4. Crear entrada en vault_references:                          â”‚
â”‚    INSERT INTO vault_references (                              â”‚
â”‚      id, tenant_id, secret_type, secret_id,                   â”‚
â”‚      reference_name, created_by, created_at                  â”‚
â”‚    ) VALUES (                                                  â”‚
â”‚      gen_random_uuid(),                                        â”‚
â”‚      'tenant-abc-123',                                         â”‚
â”‚      'cert_p12',                                               â”‚
â”‚      'uuid-del-secret',                                        â”‚
â”‚      'cert_p12',  // reference_name                           â”‚
â”‚      'user-123',                                               â”‚
â”‚      NOW()                                                      â”‚
â”‚    );                                                           â”‚
â”‚                                                                 â”‚
â”‚ 5. Auditar el acceso:                                           â”‚
â”‚    INSERT INTO vault_access_log (                              â”‚
â”‚      id, user_id, tenant_id, action, secret_type, success,   â”‚
â”‚      ip_address, error_message, created_at                   â”‚
â”‚    ) VALUES (                                                  â”‚
â”‚      gen_random_uuid(),                                        â”‚
â”‚      'user-123',                                               â”‚
â”‚      'tenant-abc-123',                                         â”‚
â”‚      'write',                                                   â”‚
â”‚      'cert_p12',                                               â”‚
â”‚      true,                                                      â”‚
â”‚      '192.0.2.1',                                              â”‚
â”‚      NULL,                                                      â”‚
â”‚      NOW()                                                      â”‚
â”‚    );                                                           â”‚
â”‚                                                                 â”‚
â”‚ 6. Retornar al servidor:                                        â”‚
â”‚    return { success: true }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 6: RESPONDER AL CLIENTE                                    â”‚
â”‚                                                                 â”‚
â”‚ âœ… HTTP 200                                                     â”‚
â”‚ {                                                               â”‚
â”‚   "success": true,                                              â”‚
â”‚   "message": "Certificado guardado correctamente",             â”‚
â”‚   "certificado": {                                              â”‚
â”‚     "issuer": "Autoridad Certificadora",                       â”‚
â”‚     "fingerprint": "AB:CD:EF:12:34:56...",                    â”‚
â”‚     "expiresAt": "2026-01-15T00:00:00Z",                      â”‚
â”‚     "uploadedAt": "2026-01-14T10:00:00Z"                      â”‚
â”‚   }                                                             â”‚
â”‚   // âŒ NUNCA incluir el certificado                           â”‚
â”‚ }                                                               â”‚
â”‚                                                                 â”‚
â”‚ âœ… P12 NUNCA se expone al cliente                              â”‚
â”‚ âœ… ContraseÃ±a NUNCA se retorna                                 â”‚
â”‚ âœ… AuditorÃ­a registrada en BD                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 7: VERIFICAR ALMACENAMIENTO                                â”‚
â”‚                                                                 â”‚
â”‚ En vault.secrets:                                               â”‚
â”‚ [ENCRIPTADO] JXK9+AhL3T7k2Px9vM4wL8+zQj1Rs0...               â”‚
â”‚ [ENCRIPTADO] 7H2W+BpK1Qy5rL3zT5eE9+xYh4Js...                â”‚
â”‚                                                                 â”‚
â”‚ En vault_references:                                            â”‚
â”‚ id: "ref-001"                                                   â”‚
â”‚ tenant_id: "tenant-abc-123"                                    â”‚
â”‚ secret_type: "cert_p12"                                        â”‚
â”‚ secret_id: "secret-uuid-123"                                   â”‚
â”‚ reference_name: "cert_p12"                                     â”‚
â”‚ created_by: "user-123"                                         â”‚
â”‚ created_at: "2026-01-14 10:00:00"                             â”‚
â”‚                                                                 â”‚
â”‚ En vault_access_log:                                            â”‚
â”‚ user_id: "user-123"                                            â”‚
â”‚ tenant_id: "tenant-abc-123"                                    â”‚
â”‚ action: "write"                                                 â”‚
â”‚ secret_type: "cert_p12"                                        â”‚
â”‚ success: true                                                   â”‚
â”‚ ip_address: "192.0.2.1"                                        â”‚
â”‚ created_at: "2026-01-14 10:00:00"                             â”‚
â”‚                                                                 â”‚
â”‚ ğŸ”’ COMPLETADO: Certificado seguro en Vault                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO DETALLADO: USAR CERTIFICADO PARA FIRMAR

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: CLIENTE SOLICITA FIRMAR FACTURA                         â”‚
â”‚                                                                 â”‚
â”‚ POST /api/facturas/123/firmar                                   â”‚
â”‚ Authorization: Bearer <JWT>                                     â”‚
â”‚                                                                 â”‚
â”‚ âœ… Cliente NO envÃ­a certificado (no lo tiene)                   â”‚
â”‚ âœ… Cliente NO envÃ­a contraseÃ±a (no la tiene)                    â”‚
â”‚ âœ… Cliente solo pide: "firma esta factura"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: SERVIDOR VALIDA                                         â”‚
â”‚                                                                 â”‚
â”‚ - Â¿Usuario autenticado? âœ… SI                                   â”‚
â”‚ - Â¿Usuario es propietario del tenant? âœ… SI                     â”‚
â”‚ - Â¿Factura existe? âœ… SI                                        â”‚
â”‚ - Â¿Factura pertenece al tenant? âœ… SI                           â”‚
â”‚ - Â¿Usuario tiene permiso de firmar? âœ… SI                       â”‚
â”‚                                                                 â”‚
â”‚ Si alguno es NO â†’ Error 403 Forbidden                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: OBTENER CERTIFICADO DEL VAULT                           â”‚
â”‚                                                                 â”‚
â”‚ const p12 = await storage.getCertificateFromVault(             â”‚
â”‚   "tenant-abc-123",                                             â”‚
â”‚   "user-123",                                                   â”‚
â”‚   "192.0.2.1"                                                   â”‚
â”‚ );                                                              â”‚
â”‚                                                                 â”‚
â”‚ Delega a vault.ts:                                             â”‚
â”‚ getSecretFromVault(supabase, "tenant-abc-123", "cert_p12", ...) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 4: VAULT.TS DESENCRIPTA EN MEMORIA                         â”‚
â”‚                                                                 â”‚
â”‚ 1. Consultar vault_references:                                  â”‚
â”‚    SELECT secret_id FROM vault_references                       â”‚
â”‚    WHERE tenant_id = 'tenant-abc-123'                           â”‚
â”‚      AND secret_type = 'cert_p12'                               â”‚
â”‚      AND reference_name = 'cert_p12';                           â”‚
â”‚                                                                 â”‚
â”‚ 2. Obtener secret_id â†’ "secret-uuid-123"                       â”‚
â”‚                                                                 â”‚
â”‚ 3. Desencriptar:                                                â”‚
â”‚    const { data } = await supabase.rpc(                        â”‚
â”‚      'vault.decrypted_secrets',                                 â”‚
â”‚      { 'secret-uuid-123' }                                      â”‚
â”‚    );                                                           â”‚
â”‚                                                                 â”‚
â”‚    Supabase desencripta:                                        â”‚
â”‚    - Lee vault.secrets[secret-uuid-123]                        â”‚
â”‚    - Obtiene Supabase-managed key                              â”‚
â”‚    - Usa XChaCha20Poly1305 para desencriptar                  â”‚
â”‚    - Retorna plaintext en memoria (NUNCA en disco)             â”‚
â”‚                                                                 â”‚
â”‚ 4. Validar RLS:                                                 â”‚
â”‚    - Â¿Secreto pertenece al tenant del usuario? âœ… SI            â”‚
â”‚    - Si NO â†’ Error 401 Unauthorized                            â”‚
â”‚                                                                 â”‚
â”‚ 5. Auditar:                                                      â”‚
â”‚    INSERT INTO vault_access_log VALUES (                        â”‚
â”‚      ..., 'user-123', 'tenant-abc-123', 'read',               â”‚
â”‚      'cert_p12', true, '192.0.2.1', NULL, NOW()              â”‚
â”‚    );                                                           â”‚
â”‚                                                                 â”‚
â”‚ 6. Retornar al servidor:                                        â”‚
â”‚    return p12; // plaintext en memoria                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 5: OBTENER CONTRASEÃ‘A                                      â”‚
â”‚                                                                 â”‚
â”‚ const password = await storage.getCertificatePasswordFromVault( â”‚
â”‚   "tenant-abc-123",                                             â”‚
â”‚   "user-123",                                                   â”‚
â”‚   "192.0.2.1"                                                   â”‚
â”‚ );                                                              â”‚
â”‚                                                                 â”‚
â”‚ Mismo proceso: desencriptar desde vault.secrets                â”‚
â”‚ AuditorÃ­a: acciÃ³n "read", secret_type "cert_password"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 6: FIRMAR LOCALMENTE EN SERVIDOR                           â”‚
â”‚                                                                 â”‚
â”‚ // P12 y contraseÃ±a SOLO existen en memoria del servidor       â”‚
â”‚ // Nunca en variables globales, nunca en BD, nunca al cliente  â”‚
â”‚                                                                 â”‚
â”‚ const signature = signXML(                                      â”‚
â”‚   facturaXML,                                                    â”‚
â”‚   p12,             // plaintext en memoria                      â”‚
â”‚   password         // plaintext en memoria                      â”‚
â”‚ );                                                              â”‚
â”‚                                                                 â”‚
â”‚ ğŸ”’ Certificado se usa y se descarta al terminar la funciÃ³n     â”‚
â”‚ ğŸ”’ ContraseÃ±a se usa y se descarta al terminar la funciÃ³n      â”‚
â”‚ ğŸ”’ Firma es lo Ãºnico que se retiene                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 7: GUARDAR FACTURA FIRMADA                                 â”‚
â”‚                                                                 â”‚
â”‚ await db.facturas.update(facturaId, {                          â”‚
â”‚   firmadoAt: NOW(),                                             â”‚
â”‚   xmlFirmado: facturaFirmadaXML,  // Con firma                 â”‚
â”‚   estadoFirma: "exitoso"                                        â”‚
â”‚   // âŒ NUNCA guardar p12                                       â”‚
â”‚   // âŒ NUNCA guardar password                                  â”‚
â”‚ });                                                             â”‚
â”‚                                                                 â”‚
â”‚ ğŸ”’ Solo se persiste la factura firmada, no el certificado       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 8: RESPONDER AL CLIENTE                                    â”‚
â”‚                                                                 â”‚
â”‚ âœ… HTTP 200                                                     â”‚
â”‚ {                                                               â”‚
â”‚   "success": true,                                              â”‚
â”‚   "facturaId": "fact-123",                                      â”‚
â”‚   "firmado": true,                                              â”‚
â”‚   "timestamp": "2026-01-14T10:05:00Z"                          â”‚
â”‚   // âŒ NUNCA: certificate, password, p12, signature           â”‚
â”‚ }                                                               â”‚
â”‚                                                                 â”‚
â”‚ âœ… Cliente recibe confirmaciÃ³n, NO el certificado              â”‚
â”‚ âœ… Certificado NUNCA saliÃ³ del servidor                         â”‚
â”‚ âœ… Toda operaciÃ³n auditada                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” COMPARATIVA DE SEGURIDAD

### ANTES (âŒ Inseguro)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BD NORMAL                                                â”‚
â”‚                                                          â”‚
â”‚ tenantCredentials Table:                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ id | tenant_id | certificado | mhPassword       â”‚  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ â”‚ 1  â”‚ tenant-1  â”‚ U2FsdGVk... â”‚ U2FsdGVk...      â”‚  â”‚
â”‚ â”‚    â”‚           â”‚ (encriptado) â”‚ (encriptado)     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ âŒ EncriptaciÃ³n: A nivel de aplicaciÃ³n (dÃ©bil)        â”‚
â”‚ âŒ Claves: En .env (texto plano)                      â”‚
â”‚ âŒ AuditorÃ­a: NO (nadie sabe quiÃ©n accediÃ³)          â”‚
â”‚ âŒ RotaciÃ³n: Manual (nunca se hace)                   â”‚
â”‚ âŒ Backups: Encriptados con claves dÃ©biles           â”‚
â”‚ âŒ DiseÃ±o: Secretos conviven con otros datos         â”‚
â”‚ âŒ Riesgo: Si hackean BD, tienen acceso a todo       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AHORA (âœ… Seguro)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUPABASE VAULT (AISLADO)                                â”‚
â”‚                                                          â”‚
â”‚ vault.secrets:                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ id  | encrypted_secret         | nonce           â”‚  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ â”‚ 001 | JXK9+AhL3T7k2Px9vM4wL... â”‚ random_bytes    â”‚  â”‚
â”‚ â”‚ 002 | 7H2W+BpK1Qy5rL3zT5eE... â”‚ random_bytes    â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ vault_references:                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ tenant_id | secret_type    | secret_id | ref_nameâ”‚  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ â”‚ tenant-1  â”‚ cert_p12       â”‚ 001       â”‚ cert     â”‚  â”‚
â”‚ â”‚ tenant-1  â”‚ cert_password  â”‚ 002       â”‚ password â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ vault_access_log:                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ user_id | tenant_id | action | success | ip      â”‚  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ â”‚ user123 â”‚ tenant-1  â”‚ read   â”‚ true    â”‚ 1.2.3.4 â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ âœ… EncriptaciÃ³n: XChaCha20Poly1305 (industrial)       â”‚
â”‚ âœ… Claves: Supabase-managed (no accesibles)          â”‚
â”‚ âœ… AuditorÃ­a: COMPLETA (quiÃ©n, cuÃ¡ndo, resultado)   â”‚
â”‚ âœ… RotaciÃ³n: AutomÃ¡tica (Supabase)                   â”‚
â”‚ âœ… Backups: Encriptados (claves fuera de BD)         â”‚
â”‚ âœ… DiseÃ±o: Separado completamente de datos normales â”‚
â”‚ âœ… Riesgo: Si hackean BD, secretos permanecen safe  â”‚
â”‚ âœ… Compliance: AEBA, GDPR, PCI-DSS ready             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ TROUBLESHOOTING

| Problema | Root Cause | SoluciÃ³n |
|----------|-----------|----------|
| `Table vault_references does not exist` | MigraciÃ³n no aplicada | Ejecutar migraciÃ³n en Supabase |
| `Permission denied on schema pg_catalog` | RLS no aplicable en Supabase | Usar validaciÃ³n en app layer (ya implementada) |
| `Secret not found` | reference_name incorrecto | Verificar nombre exacto en listTenantSecrets() |
| `Unauthorized` | Tenant mismatch | Verificar que userId pertenece al tenant |
| `Vault is slow` | Muchas queries | Cachear resultados, usar Ã­ndices |

---

**Ãšltima actualizaciÃ³n:** 2026-01-14  
**Arquitecto:** Sistema de Seguridad  
**Estado:** âœ… IMPLEMENTADO Y DOCUMENTADO
